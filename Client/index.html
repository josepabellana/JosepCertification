<!DOCTYPE html>
<html>
  <head>
    <title>Manifest Analyzer</title>
    <!-- <script src="../dst/utils.js"></script> -->
    <script src="../dst/index.js"></script>
    <script src=""></script>
    <link href="./styles.css" rel="stylesheet"> </link>
  </head>
  <body>
    <div class="container">
      <h1>Manifest Analyzer</h1>
      <div class="form-group">
        <label for="inputLink" class="form-label">Manifest Link:</label>
        <input type="text" id="inputLink" class="form-input" placeholder="Enter the manifest link" />
      </div>
      <button onclick="analyzeManifest()" class="form-button">Analyze</button>
      <table id="resultsTable" class="results-table">
        <tr>
          <th>Target Duration</th>
          <td></td>
        </tr>
        <tr>
          <th>Fragment Count</th>
          <td></td>
        </tr>
      </table>
    </div>
    
    <script>
        function analyzeManifest() {
          const inputLink = document.getElementById('inputLink');
          const link = inputLink.value.trim();
  
  
          // Perform the logic to analyze the manifest
          const url = 'https://hivejsartifacts.blob.core.windows.net/artifacts/plugins/102147/html5/dist/reference/html5/9.2.0/hivejs/silent-videojs.test.html?manifest=https://streaming-simulator-prod.hivestreaming.com/generic/live/beta-big-bunny-multi/manifest.m3u8?callback=https://api.hivestreaming.com/v1/events/9001/15/1894266/mWnCvsg73dQRIfoj';
          testLogic(url);
          // Example logic with mock results
          const targetDuration = 2;
          const fragmentCount = 15;
  
          // Display the results in the table
          const table = document.getElementById('resultsTable');
          table.innerHTML = `
            <tr>
              <th>Target Duration</th>
              <td>${targetDuration}</td>
            </tr>
            <tr>
              <th>Fragment Count</th>
              <td>${fragmentCount}</td>
            </tr>
          `;
        }



        function testLogic(url){
            getManifestURL(url)
            .then(({manifestContent, playlistContent}) => {
                // console.log(manifestContent);
                
                if (manifestContent) {
                let manifestBitrates = extractResolutionsFromManifest(manifestContent);

                if(manifestBitrates && manifestBitrates.length > 0){
                    console.log(`This manifest has ${manifestBitrates.length} bitrates`);
                    console.log('The highest Bitrate is:', manifestBitrates[0]);
                }
                }

                if(playlistContent){
                let {targetDuration, fragmentCount} = parsePlaylistContent(playlistContent);

                if(targetDuration) console.log('The playlist have the following fragment duration:', targetDuration);
                if(fragmentCount) console.log('The amount of fragments are: ', fragmentCount);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        
        }

        const launchOptions = {
            slowMo: 0,
            args: ['--use-fake-ui-for-media-stream', '--use-fake-device-for-media-stream', '--deny-permission-prompts'],
            firefoxUserPrefs: {
                'media.navigator.streams.fake': true,
                'media.navigator.permission.disabled': true
            }
        };

        function getManifestURL(url) {
        return new Promise(async (resolve, reject) => {

            const browser = await chromium.launch({...launchOptions, channel: 'chrome'});
            const context = await browser.newContext({
            viewport: { width: 1200, height: 800 },
            ignoreHTTPSErrors: true
            });
            const page = await context.newPage();

            let manifestContent = null;
            try {

            page.on('request', request => {
                
                if (request.resourceType() === 'xhr' && /manifest.m3u8$/i.test(request.url())) {
                console.log('>>', request.resourceType(), request.url());
                const manifestURL = request.url();
                console.log(`Manifest URL: ${manifestURL}`);

                request.response().then((res) => {
                    res.text().then((text) => {
                    manifestContent = text;
                    });
                });
                }

                if (request.resourceType() === 'xhr' && /playlist.m3u8$/i.test(request.url())) {
                console.log('>>', request.resourceType(), request.url());
                const playlistURK = request.url();
                console.log(`Playlist URL: ${playlistURK}`);

                request.response().then((res) => {
                    res.text().then((text) => {
                    resolve({ manifestContent, playlistContent: text});
                    // Close the browser
                    browser.close();
                    });
                });
                }

            })
            
            // const encodedUrl = encodeURIComponent(url);
            await page.goto(url, { waitUntil: 'networkidle' });
            } catch (error) {
            console.error('Error occurred during request interception:', error);
            reject('');
            } finally {
            await page.screenshot({ path: 'screenshot.png' });
            
            }
            
            
            })
        }
      </script>
       
  </body>
</html>